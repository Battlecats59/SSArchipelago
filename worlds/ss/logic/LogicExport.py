### This script is not ran by the AP World
### This is a helper script to export the python requirements into json format
### As well as update the Requirements.py file that is used by the AP World
### If you edit requirements, change the appropriate python files under the /requirements/ folder
### Then run this file to automatically export requirements
### These JSON files will be under /requirements_json/
### Requires packages re and json

import json

from Logic import (
    ALL_REQUIREMENTS,
    SKYLOFT_REQUIREMENTS,
    SKY_REQUIREMENTS,
    FARON_REQUIREMENTS,
    ELDIN_REQUIREMENTS,
    LANAYRU_REQUIREMENTS,
    SKYVIEW_REQUIREMENTS,
    EARTH_TEMPLE_REQUIREMENTS,
    LANAYRU_MINING_FACILITY_REQUIREMENTS,
    ANCIENT_CISTERN_REQUIREMENTS,
    SANDSHIP_REQUIREMENTS,
    FIRE_SANCTUARY_REQUIREMENTS,
    SKY_KEEP_REQUIREMENTS,

    BASE_MACROS,
    MACROS,
)

from LogicParser import parse_expression

with open("./requirements_json/Skyloft.json", "w") as f:
    json.dump(SKYLOFT_REQUIREMENTS, f, indent=2)

with open("./requirements_json/Sky.json", "w") as f:
    json.dump(SKY_REQUIREMENTS, f, indent=2)

with open("./requirements_json/Faron.json", "w") as f:
    json.dump(FARON_REQUIREMENTS, f, indent=2)

with open("./requirements_json/Eldin.json", "w") as f:
    json.dump(ELDIN_REQUIREMENTS, f, indent=2)

with open("./requirements_json/Lanayru.json", "w") as f:
    json.dump(LANAYRU_REQUIREMENTS, f, indent=2)

with open("./requirements_json/Skyview.json", "w") as f:
    json.dump(SKYVIEW_REQUIREMENTS, f, indent=2)

with open("./requirements_json/Earth_Temple.json", "w") as f:
    json.dump(EARTH_TEMPLE_REQUIREMENTS, f, indent=2)

with open("./requirements_json/Lanayru_Mining_Facility.json", "w") as f:
    json.dump(LANAYRU_MINING_FACILITY_REQUIREMENTS, f, indent=2)

with open("./requirements_json/Ancient_Cistern.json", "w") as f:
    json.dump(ANCIENT_CISTERN_REQUIREMENTS, f, indent=2)

with open("./requirements_json/Sandship.json", "w") as f:
    json.dump(SANDSHIP_REQUIREMENTS, f, indent=2)

with open("./requirements_json/Fire_Sanctuary.json", "w") as f:
    json.dump(FIRE_SANCTUARY_REQUIREMENTS, f, indent=2)

with open("./requirements_json/Sky_Keep.json", "w") as f:
    json.dump(SKY_KEEP_REQUIREMENTS, f, indent=2)

with open("./requirements_json/Base_Macros.json", "w") as f:
    json.dump(BASE_MACROS, f, indent=2)

with open("./Requirements.py", "w") as f:
    f.write(
"""### --------------------------------------------------- ###
### THIS FILE IS AUTOMATICALLY GENERATED USING LOGIC    ###
### SPECIFIED IN `worlds/ss/logic/requirements/`        ###
### WHEN UPDATING LOGIC, DO NOT EDIT THIS FILE DIRECTLY ###
### RATHER, UPDATE THE REQUIREMENTS AND RUN THE PY      ###
### SCRIPT `worlds/ss/logic/LogicExport.py`             ###
### --------------------------------------------------- ###
### FILE MUST BE MANUALLY CHECKED FOR ERRORS BEFORE     ###
### COMMITTING! FORMAT USING BLACK         THANK YOU!   ###
### --------------------------------------------------- ###

from typing import TYPE_CHECKING

from BaseClasses import MultiWorld
from worlds.generic.Rules import set_rule

if TYPE_CHECKING:
    from .. import SSWorld

from .Macros import BASE_MACROS

from .requirements.Skyloft import SKYLOFT_REQUIREMENTS
from .requirements.Sky import SKY_REQUIREMENTS
from .requirements.Faron import FARON_REQUIREMENTS
from .requirements.Eldin import ELDIN_REQUIREMENTS
from .requirements.Lanayru import LANAYRU_REQUIREMENTS

from .requirements.Skyview import SKYVIEW_REQUIREMENTS
from .requirements.Earth_Temple import EARTH_TEMPLE_REQUIREMENTS
from .requirements.Lanayru_Mining_Facility import LANAYRU_MINING_FACILITY_REQUIREMENTS
from .requirements.Ancient_Cistern import ANCIENT_CISTERN_REQUIREMENTS
from .requirements.Sandship import SANDSHIP_REQUIREMENTS
from .requirements.Fire_Sanctuary import FIRE_SANCTUARY_REQUIREMENTS
from .requirements.Sky_Keep import SKY_KEEP_REQUIREMENTS

ALL_REQUIREMENTS = (
    SKYLOFT_REQUIREMENTS
    | SKY_REQUIREMENTS
    | FARON_REQUIREMENTS
    | ELDIN_REQUIREMENTS
    | LANAYRU_REQUIREMENTS
    | SKYVIEW_REQUIREMENTS
    | EARTH_TEMPLE_REQUIREMENTS
    | LANAYRU_MINING_FACILITY_REQUIREMENTS
    | ANCIENT_CISTERN_REQUIREMENTS
    | SANDSHIP_REQUIREMENTS
    | FIRE_SANCTUARY_REQUIREMENTS
    | SKY_KEEP_REQUIREMENTS
)
"""
    )
    f.write('\ndef location_requirements(world: "SSWorld", loc):')
    for reg, data in ALL_REQUIREMENTS.items():
        if reg == "Batreaux's House":
            continue # Batreaux check logic will be handled at runtime
        for loc, req in data["locations"].items():
            f.write(f'\n  if loc == "{data["hint_region"]} - {loc}":\n    return (lambda state, player=world.player: {parse_expression(req)})')

    f.write('\ndef exit_requirements(world: "SSWorld", ex):')
    for reg, data in ALL_REQUIREMENTS.items():
        for exit_name, req in data["exits"].items():
            f.write(f'\n  if ex == "{reg} - {exit_name}":\n    return (lambda state, player=world.player: {parse_expression(req)})')  

    f.write(f'\ndef gratitude_crystals_macros(world: "SSWorld", macro):')

    for macro in BASE_MACROS:
        if "Gratitude Crystals" in macro:
            f.write(f'\n  if macro == "{macro}":\n    return (lambda state, player=world.player: {parse_expression(macro)})')
    
    #f.write(f'\n  else:\n    assert macro + "not found!"\n')
    f.write("\n")